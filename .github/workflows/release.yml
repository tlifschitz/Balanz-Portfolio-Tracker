name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags (e.g., v1.0.0)
  workflow_dispatch:  # Allow manual triggering

jobs:
  build-macos:
    name: Build for macOS
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build application
        run: |
          pyinstaller balanz-tracker.spec --clean --noconfirm

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Create DMG
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          DMG_NAME="BalanzTracker-${VERSION}-macOS"

          create-dmg \
            --volname "Balanz Portfolio Tracker" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "BalanzTracker.app" 175 120 \
            --hide-extension "BalanzTracker.app" \
            --app-drop-link 425 120 \
            --no-internet-enable \
            "${DMG_NAME}.dmg" \
            "dist/BalanzTracker.app" || true

          # Fallback to hdiutil if create-dmg fails
          if [ ! -f "${DMG_NAME}.dmg" ]; then
            hdiutil create -volname "Balanz Portfolio Tracker" \
              -srcfolder "dist/BalanzTracker.app" \
              -ov -format UDZO \
              "${DMG_NAME}.dmg"
          fi

          # Generate checksum
          shasum -a 256 "${DMG_NAME}.dmg" > "${DMG_NAME}.dmg.sha256"

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: |
            BalanzTracker-*.dmg
            BalanzTracker-*.dmg.sha256

  build-windows:
    name: Build for Windows
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build application
        run: |
          pyinstaller balanz-tracker.spec --clean --noconfirm

      - name: Create ZIP archive
        run: |
          $VERSION = $env:GITHUB_REF_NAME -replace '^v', ''
          $ZIP_NAME = "BalanzTracker-${VERSION}-windows-x64.zip"

          Compress-Archive -Path dist/BalanzTracker -DestinationPath $ZIP_NAME

          # Generate checksum
          $hash = (Get-FileHash $ZIP_NAME -Algorithm SHA256).Hash
          "$hash  $ZIP_NAME" | Out-File -Encoding ASCII "${ZIP_NAME}.sha256"

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            BalanzTracker-*-windows-x64.zip
            BalanzTracker-*-windows-x64.zip.sha256

  build-linux:
    name: Build for Linux
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.0-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build application
        run: |
          pyinstaller balanz-tracker.spec --clean --noconfirm

      - name: Create tar.gz archive
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          TARBALL_NAME="BalanzTracker-${VERSION}-linux-x64.tar.gz"

          cd dist
          tar -czf "../${TARBALL_NAME}" BalanzTracker/
          cd ..

          # Generate checksum
          sha256sum "${TARBALL_NAME}" > "${TARBALL_NAME}.sha256"

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: |
            BalanzTracker-*-linux-x64.tar.gz
            BalanzTracker-*-linux-x64.tar.gz.sha256

  create-release:
    name: Create GitHub Release
    needs: [build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Prepare release files
        run: |
          mkdir release-files
          find artifacts -type f \( -name "*.dmg" -o -name "*.zip" -o -name "*.tar.gz" -o -name "*.sha256" \) -exec cp {} release-files/ \;
          ls -lh release-files/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release-files/*
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
